---
stages:
  - sync
  - build
  - publish

sync_shared_assets:
  stage: sync
  image: python:3.11
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'

  script:
    - apt-get update && apt-get install -y --no-install-recommends git ca-certificates curl && rm -rf /var/lib/apt/lists/*
    - |
      curl -fsSL https://gitlab.com/lit4/modulix/platform/software-development-ecosystem/automation-tools/shared-assets/-/raw/main/collections/common/scripts/sync_shared_assets.sh | bash
    - |
      if [ -n "$(git status --short)" ]; then
        git config user.name "shared-assets-bot"
        git config user.email "shared-assets-bot@l-it.io"
        git add -A
        git commit -m "chore shared-assets sync common assets"
        git push origin HEAD:"$CI_COMMIT_REF_NAME"
        echo "Assets updated and pushed; stopping pipeline."
        exit 1
      else
        echo "Shared assets already up to date."
      fi
